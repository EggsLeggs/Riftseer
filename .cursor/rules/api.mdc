---
description: Rules for packages/api — ElysiaJS REST server
globs: ["packages/api/**/*.ts"]
alwaysApply: false
---

# packages/api Rules

## Elysia Conventions
- Each API version is a standalone Elysia sub-app with a `prefix` — **never use `.group()`**:
  ```typescript
  // ✅ Correct
  const v1 = new Elysia({ prefix: "/api/v1" }).get("/health", ...)
  const app = new Elysia().use(cors(...)).use(v1).use(swagger(...)).listen(...)
  ```
- Add new routes to the appropriate versioned sub-app (`v1`, `v2`, …), not to the root app
- The swagger plugin goes on the **root app only** — it auto-discovers routes from all mounted sub-apps
- Use `.get()`, `.post()` etc. with Elysia's schema annotations for automatic Swagger generation
- Do not create a separate Express-style router pattern — Elysia handles composition natively

## Response Hygiene
- Strip the `raw` field from card objects before sending responses (it's internal to providers)
- Return `{ error: string }` with the appropriate HTTP status for error cases (400 / 404 / 500)
- Never expose internal stack traces in API responses

## Testing Routes
```typescript
// Correct pattern — no live server needed
const res = await app.handle(new Request('http://localhost/api/health'))
const data = await res.json()
```

## Batch Limits
- `POST /api/resolve` accepts a maximum of 20 `CardRequest` items — validate and return 400 if exceeded

## New Routes Checklist
1. Add handler in `src/index.ts` with Elysia schema
2. Add test in `src/__tests__/routes.test.ts`
3. If the route exposes or logs new user/request data, update `packages/frontend/src/components/PrivacyPage.tsx`

## Provider Access
- The provider is initialized once at startup via `createProvider()` from `@riftseer/core`
- Do NOT re-initialize or call `createProvider()` per-request
- All card operations go through the `CardDataProvider` interface — do not import concrete providers directly
